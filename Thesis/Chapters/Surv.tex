\chapter{Survival Analysis Bakground}\label{survchap}

\section{Survival Functions}

Given a homogeneous population of individuals, the time of death for each individual is drawn from a continuous random variable $T > 0$ with probability density function $f(t)$ and distribution function $F(t) = \int_{0}^{t}f(\tau)d\tau$. Survival analysis is concerned with estimating the distribution $T$ from Time-To-Event (TTE) data. There are two functions central to survival analysis, the \textit{survival function} and \textit{hazard function}.

\begin{definition}{Survival Function}{h}
    The \textbf{Survival Function} $S(t)$, gives the probability of an individual surviving longer than time $t$. 
    \[
        S(t) = P(T \geq  t) = 1 - F(t) = \int_{t}^{\infty}f(\tau)d\tau  
    \]
\end{definition}

\begin{definition}{Hazard Function}{h}
    The \textbf{Hazard Function} gives the risk of death at time $t$, given that the individual has survived up to time $t$. 
    
    \[
        h(t) = -\frac{d}{dt}\log S(t)  
    \]
\end{definition}

\section{The Kaplan-Meier Estimator and Digitisin Survival Curves}
\subsection{The Kaplam-Meier Estimator}
The KM estimator is a non-parametric method for estimating the survival function from event and censoring times. TTE data contains, at a bare minimum, a subject identifier, an event time, and a censoring indicator. The Censoring indicator is given in Equation~\ref{censInd}. The time column of data gives the time that either the event (i.e, death due to the disease being investigated, in overall survival), or censoring (i.e a chemotherapy patient dies after being hit by a bus not their cancer) occurs.

\begin{equation}
    c_{i} = \begin{cases}
        1 \ \text{If inividual i has an event} \\
        0 \ \text{If individual i is censored}
    \end{cases}
    \label{censInd}  
\end{equation}

Let $d_i$ and $n_i$ be the number of events and total individuals at risk at the $i^{th}$ timepoint, $t_i$. Define the discrete hazard rate $h_i$ as the probability that individual experiences an event at time $t_i$. The survival rate is then defined as in Equation~\ref{survrate}, and the likelihood function for the hazard function up to time $t_i$ is given by Equation~\ref{hazllhood}.

\begin{equation}
    S(t) = \prod_{i:t_i \leq t} (1 - h_i)
    \label{survrate}
\end{equation}

\begin{equation}
    \mathcal{L}(h_{j\leq i}|d_{j:j\leq i}, n_{j:j\leq i}) = \prod_{j=1}^i h_j^{d_j}(1-h_j)^{n_j-d_j}\binom{n_j}{d_j}
    \label{hazllhood}
\end{equation}

The KM estimator can be derived by Maximum Likelihood Estimation (MLE) of the discrete hazard function. By obtaining an maximum likelihood estimate of $h_i$, $\hat{h_i}$, and substituting it into Equation~\ref{survrate}, the resulting estimate of the survival function, $\hat{S(t)}$, is the KM estimator.

Taking logs of Equation~\ref{hazllhood} gives Equation~\ref{loghazlik}.

\begin{equation}
    log(\mathcal{L}) = \sum_{j=1}^i \left(d_j\log(h_j)+(n_j-d_j)\log(1-h_j) + \log \binom{n_j}{d_j}\right)
    \label{loghazlik}
\end{equation}

By taking the derivative of Equation~\ref{loghazlik} with respect to $h_i$, and setting the resulting fraction equal to zero, $\hat{h_i}$ is obtained as in Equation~\ref{kmHaz}.

\begin{align}
    \frac{\partial \log(\mathcal{L})}{\partial h_i} &= \frac{\partial}{\partial h_i}\left(\sum_{j=1}^i \left(d_j\log(h_j)+(n_j-d_j)\log(1-h_j) + \log \binom{n_j}{d_j}\right)\right) \\
    &= \frac{d_i}{\hat{h_i}} - \frac{n_i - d_i}{1 - \hat{h_i}}
\end{align}

\begin{equation}
    \frac{\partial \log (\partial )}{\partial h_i} = 0 \Rightarrow \hat{h_i} = \frac{d_i}{n_i}
    \label{kmHaz}
\end{equation}

\begin{definition}{Kaplain-Meier Estimator}
    TThe \textbf{Kaplan-Meier Estimator}, $\hat{S(t)}$, estimates the survival probability that an individual survives longer than time $t$, and is given by Equation~\ref{kmeq}. 
\begin{equation}
    \hat{S(t)} = \prod_{i:t_i \leq t}\left(1 - \frac{d_i}{n_i}\right)
    \label{kmeq}
\end{equation}
\end{definition}

\section{Reconstructing Survival Data from Published Curves}
The ML-NMR method requires aggregate survival data to be in the form of the TTE data previously described. Often, the actual patient level event and censoring times/indicators are not published, and therefore must be reconstructed from the published KM curves, which are usually readily available. Indeed, one of the study selection criteria outlined in Section~\ref{sec:aims} was that studies must publish KM curves with numbers at risk. This was motivated by the method for reconstructing patient-level data from KM curves, the Guyot algorithm~\cite{guyotipd} requiring numbers at risk.

\section{Regression Models for Survival}

The survival time of patients may be dependent on several explanatory variables such as age, sex, the presence of a genetic mutation, etc. We wish to incorperate these variables into our survival functions. There are two forms of models for survival data. Accelerated Failure Time (AFT) models, and Proportional-Hazards (PH models).

\subsection{Accelerated Failure Time Models}

Let $x$ be a vector of explanatory variables for each individual in a trial. The survival function can be extended to include this,

\[
    S(t, x) = S_0(t\Psi(x)).
\]

Here, $S_0(t) = S(t, x = 0)$, i.e the survival function at baseline. We define the density and hazard functions accordingly,

\begin{align*}
    f(t, x) &= f_0(t\Psi(x))\Psi(x) \\
    h(t, x) &= h_0(t\Psi(x))\Psi(x).
\end{align*}

This is equivalent to defining a random variable $T$ such that

\[
    T = T_0/\Psi(x).  
\]

Here, $T_0$ has survivor function $S_0$. It is required that $\Psi(x) \geq 0$ and $\Psi(0) = 1$, leading to the natural choice 

\[
    \Psi(x) = \exp(-\beta'x).  
\]

We can then write 

\begin{align*}
    T &= T_0/\Psi(x) \\
    \implies E(T) &= E(T_0)/E(e^{-\beta'x}) \\
    &= E(T_0)/e^{-\beta'x} \\
    &= E(T_0)e^{\beta'x}
\end{align*}

In practice, we assume a distribution for $T$, and estimate parameters using maximum likelihood estimation. 

\subsection{Proportional Hazards Models}

Let $h_0$ represent the hazard function for an individual at baseline. In addition, let $\bf{x}$ be a vector of explanatory variables. The proportional hazards model, also known as the Cox model~\cite{cox1972} is then given by 

\begin{equation}
    h(t, x) = \exp(\beta'x) \ h_0(t)
    \label{coxmodel}
\end{equation}

Consider the following defintion.

\begin{definition}{Semi Parametric Model}{h}
    A statistical model is a parameterised family of distributions $\{P_{\theta} : \theta \in \Theta\}$. 
    For a parametric model, $\Theta \subseteq \mathbb{R}^k$ for $k \in \mathbb{N}$. Similarly, for a non-parametric model, $\Theta \subseteq V$, where $V$ is some (possibly infinite) dimensional space $V$. A \textbf{Semi-parametric} model is a statistical model with both parametric and non-parametrc components. For a semi-parametric model we have $\Theta \subseteq \mathbb{R}^k \times V$.
\end{definition}

The Cox model is semi-parametric then $\beta$ is of finite dimension and $h_0(t)$ is infinite-dimensional and does not need to be specified. 

\section{Key Survival Metrics}

\subsection{The Hazard Ratio}
The Hazard Ratio (HR) follows from Equation~\ref{coxmodel}. Consider two treatments, $i = 1, 2$, then $h_1(t, x) = \exp(\beta'x) \ h_0(t)$ and $h_2(t, x) = \exp(\beta'x) \ h_0(t)$. The HR is obtained as in Equation~\ref{HReq}.

\begin{equation}
    HR = \frac{h_1}{h_2} = \exp(\beta' x)
    \label{HReq}
\end{equation}

In practice, the HR is a useful endpoint in performing network meta-analyses on survival outcomes. However, in order to conduct a HR-based Network Meta Analysis (NMA), the proportional hazards assumption (PHA), must be satisfied. The PHA is the assumtpion that the HR remains constant throughout the observation period of a trial. It can be tested by visual-inspection of a log-cumulative hazards plot. 

\begin{definition}{Cumulative Hazard Function}
    BThe \textbf{Cumulative Hazard Function}, $H(t)$ is given by 
    \[
        H(t) = \int_{0}^{x}h(t)dt = -\log(S(t))  
    \]
\end{definition}

By extention, the log-cumulative hazard function is given by $\log(-\log(S(t)))$. When plotting this for both arms of a clinical trial, if the curves remain roughly parallel, the PHA is likely satisfied, but if they curves cross, it indicates violation of the PHA.

\subsection{Restriced Mean Survival Time}
The RMST is alternative measure to the (log) HR in NMAs. RMST is the mean survival time up to a pre-specified time. This measure can be thought of visually as the area under the survival curve. Definition~\ref{def:rmst} presents the formal definition.

\begin{definition}{RMST}
    AFor a survival function $S(t)$, the \textbf{RMST} for some pre-specified time $x > 0$,
    \[
        RMST = \int_{0}^{x} S(t)dt
    \] 
    \label{def:rmst}
\end{definition}

\subsection{Median Survival}
Median survival is simply the earliest timepoint at which 50\% of patients have died. 

\section{Parametric Models for Survival Analysis}
This section discusses the parametric models commonly used in Survival Analysis. In particular, the seven parametric models recommended by the National Institute for Health and Care Excellence (NICE) in Technical Support Document (TSD) 14~\cite{tsd14}. All parametric model fitting for this project was performed in \verb|R| using the \verb|flexsurv| package~\cite{flexsurv}. The first section outlines how the \verb|flexsurv| package works.

\subsection{Model Setup}
The general model of a \verb|flexsurv| survival model takes the form 

\begin{equation}
    \label{fsurvmodel}
    f(t|\mu(\bf{z}), \bf{\alpha}(\bf{z})).
\end{equation}

Equation~\ref{fsurvmodel} gives the probability density for death at time $t \geq 0$. The \textit{mean} or \textit{location} of the distribution is given by $\mu = \alpha_0$. The remaining parameters, $\bf{\alpha^1} = (\alpha_1, \ldots, \alpha_R)$ are called \textit{ancillary} parameters. \\

Chapter~\ref{survchap} discussed AFT and PH models. Under the \verb|flexsurv| framework, if the hazard function, $h(t) = \frac{f(t)}{S(t)}$, can be factorised as 

\[
    h(t|\bf{\alpha}, \mu(\bf{z})) = \mu(\bf{z})h_0(t|\bf{\alpha}). 
\] 

Then we have a PH model. On the other hand, an AFT model would be written as

\[
    S(t|\mu(\bf{z}), \bf{\alpha}) = S_0(\mu(\bf{z})t/\bf{\alpha}).  
\]

All parameters may depend on $\bf{z}$, a vector of covariates. This is done through the link-transformed linear models

\begin{align}
    \label{flexsurvMLE}
    g_0(\mu(\bf{z})) &= \gamma_0 + \bf{\beta}_0^Tz \nonumber \\
    g_r(\alpha_r(\bf{z})) &= \gamma_r + \bf{\beta}_{\gamma}^T\bf{z}
\end{align}

$g$ is usally chosen to be $log()$ if the parameter is positive, or the identity function if the parameter is unrestricted.\\

\subsection{Fitting Models}
Let $t_i$, $i \in \{1, \ldots, n\}$, be a sample of times from $n$ individuals. Define $c_i$ such that 

\[
    c_i = \begin{cases*}
        1 & \text{if $t_i$ is an observed death time} \\
        0 & \text{if $t_i$ is censored} 
    \end{cases*}  
.\]

Introduce $s_i$, which are delayed-entry times. This means for an individual $i$ who is delayed-entry, the survival time is only observed conditionally on individual $i$ having survived up to time $s_i$. $s_i = 0$ when there is no delayed-entry. \\

\subsubsection{Right Censoring}
In the case of right-censoring and nothing else, the likelihood for the parameters $\bf{\theta} = \{\bf{\gamma}, \bf{\beta}\}$ required in Equation~\ref{flexsurvMLE} is given by 

\begin{equation}
    \label{flexsurvRightCens}
    l(\bf{\theta}|t,c,s) = \frac{\prod_{i:c_i=1} f_i(t_i) \prod_{i:c_i=0} S_i(t_i)}{\prod_{i} S_i(s_i)}
\end{equation}

\subsubsection{Interval Censoring}
In the case of interval-censoring, where the survival time is censored on $(t_i^{\text{min}}, t_i^{\text{max}})$, the likelihood for $\theta = \{\gamma, \beta\}$ is 

\begin{equation}
    \label{flexSurvIntCens}
    l(\theta|t^\text{min}, t^\text{max}, c,s) = \frac{\prod_{i:c_i=1} f_i(t_i) \prod_{i:c_i=0} \left(S_i(t_i^{\text{min}}) - S_i(t_i^{\text{max}}) \right)}{\prod_{i} S_i(s_i)}
\end{equation}

Maximum Likelihood Estimation is performed in \verb|R| using the analytic derivatives of Equation~\ref{flexsurvRightCens} and/or Equation~\ref{flexSurvIntCens}. 
